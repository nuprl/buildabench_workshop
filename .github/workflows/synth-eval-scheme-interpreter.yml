name: synth-eval-scheme-interpreter

on:
  push:
    paths:
      - ".github/workflows/synth-eval-scheme-interpreter.yml"
      - "test_projects/scheme_interpreter/**"
      - "src/buildabench_workshop/**"
  pull_request:
    paths:
      - ".github/workflows/synth-eval-scheme-interpreter.yml"
      - "test_projects/scheme_interpreter/**"
      - "src/buildabench_workshop/**"
  workflow_dispatch:

jobs:
  synth-eval:
    runs-on: self-hosted
    env:
      OPENAI_MODEL: openai/boa
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}
      CONTAINER_NAME: env_agent__scheme_interpreter_${{ github.run_id }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Add Codex CLI to PATH
        run: echo "/home/ci/codexcli/node_modules/.bin" >> "$GITHUB_PATH"

      - name: Build container via env_agent
        run: |
          uv run python3 -m buildabench_workshop.env_agent \
            --repo test_projects/scheme_interpreter \
            --tips-path test_projects/scheme_interpreter/env_agent_tips.txt \
            --agent codex \
            --container "$CONTAINER_NAME"

      - name: Synthesize 3 tasks
        run: |
          uv run python3 -m buildabench_workshop.synth_task \
            --json \
            --num-candidates 3 \
            --model openai/boa \
            test_projects/scheme_interpreter \
            "src/scheme_interpreter/*.py" \
            "tests/*.py" \
            > test_projects/scheme_interpreter/ci_tasks.jsonl

      - name: Print synthesized tasks
        run: |
          uv run python3 - <<'PY'
          import json
          from pathlib import Path

          tasks_path = Path("test_projects/scheme_interpreter/ci_tasks.jsonl")
          for line in tasks_path.read_text().splitlines():
            if not line.strip():
              continue
            task = json.loads(line)
            subject = task.get("subject", "<missing subject>")
            patches = task.get("patches", "")
            if isinstance(patches, list):
              patch_text = "\n".join(patches)
            else:
              patch_text = patches
            print("Subject:", subject)
            print("Patch:")
            print(patch_text)
            print()
          PY

      - name: Build validated tasks manifest
        run: |
          uv run python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          tasks_path = Path("test_projects/scheme_interpreter/ci_tasks.jsonl")
          validated_path = Path("test_projects/scheme_interpreter/ci_validated_tasks.jsonl")
          container = os.environ["CONTAINER_NAME"]
          with validated_path.open("w") as out:
            for line in tasks_path.read_text().splitlines():
              if not line.strip():
                continue
              task = json.loads(line)
              task_id = task.get("task_id")
              if not task_id:
                continue
              out.write(json.dumps({"task_id": task_id, "container": container}) + "\n")
          PY

      - name: Eval tasks with codex
        run: |
          uv run python3 - <<'PY'
          import json
          import subprocess
          import sys
          from pathlib import Path

          tasks_path = Path("test_projects/scheme_interpreter/ci_tasks.jsonl")
          validated_path = Path("test_projects/scheme_interpreter/ci_validated_tasks.jsonl")

          failures = 0
          passes = 0

          with tasks_path.open() as f:
            for line in f:
              if not line.strip():
                continue
              task = json.loads(line)
              task_id = task.get("task_id")
              subject = task.get("subject", "<missing subject>")
              if not task_id:
                print(f"{subject}: FAIL (missing task_id)")
                failures += 1
                continue
              result = subprocess.run(
                [
                  "uv", "run", "python3", "-m", "buildabench_workshop.eval_agent_unvalidated",
                  "--tasks", str(tasks_path),
                  "--validated-tasks", str(validated_path),
                  "--task-id", task_id,
                  "--agent-name", "codex",
                  "--summary",
                ],
                capture_output=True,
                text=True,
              )
              status_line = result.stdout.strip()
              if status_line:
                print(status_line)
                status = "PASS" if status_line.endswith("PASS") else "FAIL"
              else:
                status = "PASS" if result.returncode == 0 else "FAIL"
                print(f"{task_id}: {subject}: {status}")
              if status == "PASS":
                passes += 1
              else:
                failures += 1

          if passes < 1:
            sys.exit(1)
          PY

      - name: Cleanup container
        if: always()
        run: |
          podman image rm -f "$CONTAINER_NAME" || true
